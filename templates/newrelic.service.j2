[Unit]
Description=New Relic Server Monitoring
Requires=docker.socket
After=docker.socket

[Service]
ExecStartPre=/bin/sh -c "docker history {{ newrelic_image }} >/dev/null 2>&1 || docker pull {{ newrelic_image }}"
ExecStartPre=/bin/sh -c "docker inspect nrsysmond >/dev/null 2>&1 && docker rm -f nrsysmond || true"
ExecStart=/usr/bin/docker run -d --privileged=true --name nrsysmond --pid=host --net=host -v /sys:/sys -v /dev:/dev -v /var/run/docker.sock:/var/run/docker.sock -v /var/log:/var/log:rw -e NRSYSMOND_license_key={{ newrelic_license_key }} -e NRSYSMOND_logfile={{ newrelic_logfile }} {{ newrelic_image }}
ExecStopPost=-/usr/bin/docker rm -f nrsysmond
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target

[X-Fleet]
Global=true
